<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moonlight API Demo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
    }
    .editor-section {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .control-panel {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { margin: 0 0 20px 0; font-size: 24px; }
    h2 { margin: 0 0 12px 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #f0f0f0; }
    button:active { background: #e0e0e0; }
    button.active { background: #4CAF50; color: white; border-color: #4CAF50; }
    #editor-container {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    #event-log {
      background: #1a1a2e;
      color: #00ff88;
      font-family: monospace;
      font-size: 12px;
      padding: 12px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      margin-top: 8px;
    }
    #event-log .log-entry {
      margin-bottom: 4px;
      padding: 2px 0;
      border-bottom: 1px solid #333;
    }
    #event-log .log-time { color: #888; }
    #element-list {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 12px;
    }
    #element-list .element-item {
      padding: 4px 8px;
      margin: 2px 0;
      background: white;
      border-radius: 3px;
      cursor: pointer;
    }
    #element-list .element-item:hover { background: #e8f5e9; }
    #element-list .element-item.selected { background: #4CAF50; color: white; }
    .status-bar {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
    .status-item { display: flex; align-items: center; gap: 4px; }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }
    .status-dot.active { background: #4CAF50; }
  </style>
</head>
<body>
  <div class="container">
    <div class="editor-section">
      <h1>Moonlight API Demo</h1>
      <div id="editor-container"></div>
      <div class="status-bar">
        <div class="status-item">
          <span class="status-dot" id="focus-indicator"></span>
          <span>Focus</span>
        </div>
        <div class="status-item">
          <span>Mode: <strong id="mode-display">select</strong></span>
        </div>
        <div class="status-item">
          <span>Selected: <strong id="selection-count">0</strong></span>
        </div>
      </div>
    </div>

    <div class="control-panel">
      <h2>Selection API</h2>
      <div class="btn-group">
        <button onclick="editor.selectAll()">Select All</button>
        <button onclick="editor.deselect()">Deselect</button>
      </div>

      <h2>Focus API</h2>
      <div class="btn-group">
        <button onclick="editor.focus()">Focus</button>
        <button onclick="editor.blur()">Blur</button>
      </div>

      <h2>Mode API</h2>
      <div class="btn-group">
        <button id="btn-select" class="active" onclick="setMode('select')">Select Mode</button>
        <button id="btn-freedraw" onclick="setMode('freedraw')">Freedraw Mode</button>
      </div>

      <h2>Element API</h2>
      <div class="btn-group">
        <button onclick="deleteSelected()">Delete Selected</button>
        <button onclick="refreshElements()">Refresh List</button>
      </div>
      <div id="element-list"></div>

      <h2>Event Log</h2>
      <div id="event-log"></div>
      <button onclick="clearLog()" style="margin-top: 8px;">Clear Log</button>
    </div>
  </div>

  <script type="module">
    import '/embed.ts';

    let editor;

    window.addEventListener('load', () => {
      const container = document.getElementById('editor-container');
      editor = window.MoonlightEditor.create(container, {
        width: 600,
        height: 400,
        theme: 'light'
      });

      // Expose editor globally for button handlers
      window.editor = editor;

      // Set up event subscriptions
      editor.onChange(() => {
        logEvent('change', 'Elements changed');
        refreshElements();
      });

      editor.onSelect((ids) => {
        logEvent('select', `Selected: [${ids.join(', ')}]`);
        document.getElementById('selection-count').textContent = ids.length;
        updateElementListSelection(ids);
      });

      editor.onDeselect(() => {
        logEvent('deselect', 'Deselected all');
        document.getElementById('selection-count').textContent = '0';
        updateElementListSelection([]);
      });

      editor.onFocus(() => {
        logEvent('focus', 'Editor focused');
        document.getElementById('focus-indicator').classList.add('active');
      });

      editor.onBlur(() => {
        logEvent('blur', 'Editor blurred');
        document.getElementById('focus-indicator').classList.remove('active');
      });

      editor.onModeChange((mode) => {
        logEvent('modeChange', `Mode: ${mode}`);
        document.getElementById('mode-display').textContent = mode;
        document.getElementById('btn-select').classList.toggle('active', mode === 'select');
        document.getElementById('btn-freedraw').classList.toggle('active', mode === 'freedraw');
      });

      editor.onElementAdd((id) => {
        logEvent('elementAdd', `Added: ${id}`);
      });

      editor.onElementDelete((id) => {
        logEvent('elementDelete', `Deleted: ${id}`);
      });

      // Initial element list
      refreshElements();
    });

    function logEvent(type, message) {
      const log = document.getElementById('event-log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span> <strong>${type}</strong>: ${message}`;
      log.insertBefore(entry, log.firstChild);
    }

    window.clearLog = function() {
      document.getElementById('event-log').innerHTML = '';
    };

    window.setMode = function(mode) {
      editor.setMode(mode);
    };

    window.deleteSelected = function() {
      const ids = editor.getSelectedIds();
      if (ids.length > 0) {
        editor.deleteElements(ids);
      }
    };

    window.refreshElements = function() {
      const list = document.getElementById('element-list');
      const elements = editor.getElements();
      const selectedIds = editor.getSelectedIds();

      list.innerHTML = elements.map(el => {
        const isSelected = selectedIds.includes(el.id);
        const shapeType = getShapeType(el.shape);
        return `<div class="element-item${isSelected ? ' selected' : ''}"
                     onclick="selectElement('${el.id}')">${el.id} (${shapeType})</div>`;
      }).join('');
    };

    function getShapeType(shape) {
      if (!shape) return 'unknown';
      // MoonBit enum is serialized as an object with type info
      if (typeof shape === 'object') {
        const keys = Object.keys(shape);
        if (keys.length > 0) return keys[0];
      }
      return 'shape';
    }

    window.selectElement = function(id) {
      editor.select([id]);
    };

    function updateElementListSelection(selectedIds) {
      const items = document.querySelectorAll('#element-list .element-item');
      items.forEach(item => {
        const id = item.textContent.split(' ')[0];
        item.classList.toggle('selected', selectedIds.includes(id));
      });
    }
  </script>
</body>
</html>
